module.exports=function(){function y(){f("CONNECTING to "+r);c=new t(r);c.onopen=function(a){c.readyState==t.OPEN&&(m(v),h=!0);f("CONNECTED")};c.onclose=function(a){f("DISCONNECTED");h=!1};c.onmessage=function(a){c.send(".");if("ping"!=a.data){try{var b=JSON.parse(a.data);if(b.data.hasOwnProperty("_MESSAGE_ID")&&p.hasOwnProperty(b.data._MESSAGE_ID)){var d=p[b.data._MESSAGE_ID];+new Date<d.expiration&&(delete b.data._MESSAGE_ID,d.fn(b.data));delete p[b.data._MESSAGE_ID]}else if(void 0!==l[b.recipient])l[b.recipient](b);
else f("no handler for event: "+a.data)}catch(g){f("ERROR: parse exception for event data "+a.data)}f("RESPONSE: "+a.data)}};c.onerror=function(a){w();f("ERROR: "+a)}}function k(a){c&&c.readyState!=t.CONNECTING?a():setTimeout(function(){k(a)},200)}function m(a){c&&c.send(a)&&f("SENT: "+a)}function u(a,b){h&&m("sendjson "+a+" "+JSON.stringify(b))}function z(a,b){h&&x(a,function(d){var g={_MESSAGE_ID:d.data._MESSAGE_ID};b(d.data,g);u(d.sender,g)})}function x(a,b){h&&(m("subscribe "+a),l[a]=b)}function A(a){h&&
(m("unsubscribe "+a),l[a]=function(){})}function B(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}var r="ws://localhost/ws",v,l={},p={},c,h=!1,f=function(a){},w=function(){},t=require("websocket").w3cwebsocket;return{connect:function(a,b,d){r=a;v=b&&0<b.length?b:"webclient_"+ +new Date;l[b]=d;y()},send:function(a,b){k(function(){u(a,b)})},call:function(a,b,d,g){k(function(){if(h){var n=B();p[n]={expiration:+new Date+
d,fn:g};b._MESSAGE_ID=n;b._MESSAGE_HANDLE=a;m("sendjson "+a+" "+JSON.stringify(b))}})},register:function(a,b){k(function(){z(a,b)})},subscribe:function(a,b){k(function(){x(a,b)})},unsubscribe:function(a){k(function(){A(a)})},variable:function(a,b){function d(e){n.forEach(function(C){C(e)})}function g(e){arguments.length&&e!==q&&(q=e,d(e),u(a,{name:q}));return q}var n=[],q;g.subscribe=function(e){n.push(e)};this.subscribe(a,function(e){e.data.hasOwnProperty(b)&&g(e.data[b])});return g},isConnected:function(){return h},
close:function(){k(function(){c&&c.close()})},handlers:function(){return l},logger:function(a){f=a},error:function(a){w=a}}}();
